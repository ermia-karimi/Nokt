<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF فارسی دقیق با OCR</title>
    <link rel="stylesheet" href="./style.css">

    <script type="module">
        import * as pdfjsLib from 'https://unpkg.com/pdfjs-dist@5.4.149/build/pdf.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://unpkg.com/pdfjs-dist@5.4.149/build/pdf.worker.mjs';

        window.extractPDFTextOCR = async function (file, outputEl) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);

                // رندر صفحه روی canvas با scale بالا برای دقت OCR
                const viewport = page.getViewport({ scale: 3 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // OCR با Tesseract.js v4
                const { data: { text } } = await Tesseract.recognize(
                    canvas,
                    'fas+eng',
                    { logger: m => console.log(m) }
                );

                fullText += formatText(text) + '\n\n';
            }

            // RTL و راست‌چین
            outputEl.style.direction = 'rtl';
            outputEl.style.textAlign = 'right';
            outputEl.textContent = fullText;
        };

        // شکستن خطوط طولانی
        function formatText(text, maxLen = 80) {
            const lines = [];
            const words = text.split(/\s+/);
            let line = '';
            for (const w of words) {
                if ((line + ' ' + w).length > maxLen) {
                    lines.push(line.trim());
                    line = w;
                } else {
                    line += ' ' + w;
                }
            }
            if (line) lines.push(line.trim());
            return lines.join('\n');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

</head>

<body>

    <a class="ar" id="ar" href="index.html"> بازگشت </a>
    <!-- <h3>PDF فارسی دقیق با OCR (v4)</h3> -->

    <div class="all-pdf">

        <div class="file-upload">

            <input type="file" id="pdfInput" accept="application/pdf" class="in">
            <label id="pickLabel" class="btn1" for="pdfInput" title=""></label>

        </div>


        <pre id="output"
            style="white-space: pre-wrap; border:1px solid #ccc; border-radius: 20px; padding:10px; max-height:400px; overflow:auto; min-height:50px; width:90%; margin-top:20px; font-family: v;"></pre>

        <!-- <button id="backBtnn" class="backBtn" onclick="goBack()">بازگشت</button> -->


    </div>

    <script>
        const pdfInput = document.getElementById('pdfInput');
        const output = document.getElementById('output');

        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            output.textContent = ' لطفا صبور باشید فرایند پردازش کمی طولانی است نسبت به پی دی اف';
            window.extractPDFTextOCR(file, output)
                .catch(err => output.textContent = 'خطا: ' + err);
        });
    </script>




    <script src="./app.js"></script>
</body>

</html>
