<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>Ù†Ú©ØªØ§ | Ù¾ÛŒ Ø¯ÛŒ Ø§Ù Ø¨Ù‡ Ù…ØªÙ† </title>


    <script type="module">
        import * as pdfjsLib from 'https://unpkg.com/pdfjs-dist@5.4.149/build/pdf.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://unpkg.com/pdfjs-dist@5.4.149/build/pdf.worker.mjs';

        window.startProcess = async file => {
            const out = document.getElementById('output');
            out.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´';

            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

            let finalText = '';
            let totalPages = pdf.numPages;
            let donePages = 0;
            let displayedPercent = 0;

            function smoothUpdate(target) {
                const animate = () => {
                    if (displayedPercent < target) {
                        displayedPercent += Math.min(0.5, target - displayedPercent);
                        document.getElementById('bar').style.width = displayedPercent + '%';
                        requestAnimationFrame(animate);
                    } else {
                        displayedPercent = target;
                        document.getElementById('bar').style.width = displayedPercent + '%';
                    }
                }
                animate();
            }

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 4 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport }).promise;

                const { data } = await Tesseract.recognize(
                    canvas,
                    'fas+eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progressPercent = ((donePages + m.progress) / totalPages) * 100;
                                smoothUpdate(progressPercent);
                            }
                        }
                    }
                );

                const paragraphs = data.blocks.map(b => b.text).filter(t => t.trim());
                finalText += fixText(paragraphs.join('\n\n')) + '\n\n';
                donePages++;
                smoothUpdate((donePages / totalPages) * 100);
            }

            out.textContent = finalText;
        };

        /* ---------- Ø§ØµÙ„Ø§Ø­ Ù…ØªÙ† ---------- */
        function fixText(text) {
            text = text.replace(/ÙŠ/g, 'ÛŒ').replace(/Ùƒ/g, 'Ú©').replace(/\u200c/g, ' ');
            text = text.replace(/\n([\.\!\?\ØŸ\:]+)/g, '$1');
            text = text.replace(/\s+([\.\!\?\ØŸ\:])/g, '$1');
            text = text.replace(/([\.\!\?\ØŸ\:])(?=\S)/g, '$1 ');
            text = text.replace(/([^\.\!\?\ØŸ\:])\n+(?=[Ø¢-ÛŒ])/g, '$1 ');
            text = text.replace(/\bÙ…ÛŒ\s+/g, 'Ù…ÛŒâ€Œ');
            text = text.replace(/\bÙ†Ù…ÛŒ\s+/g, 'Ù†Ù…ÛŒâ€Œ');
            text = text.replace(/\s+/g, ' ').trim();
            return text;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>

<body>
    <a class="ar" id="ar" href="index.html">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
    <div class="all-pdf">


        <!-- <h3>OCR ÙØ§Ø±Ø³ÛŒ â€” Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ + Smooth Progress</h3> -->




        <div class="file-upload">

            <input type="file" id="pdfInput" accept="application/pdf" class="in">
            <label id="pickLabel" class="btn1" for="pdfInput" title=""></label>

        </div>


        <div class="btnd">

            <button onclick="copyText()" class="btnk">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            <button onclick="downloadText()" class="btnk">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯</button>

        </div>



        <div class="progressBox">
            <div class="progressBar" id="bar"></div>
        </div>
        <pre id="output"
            placeholder="ØªØ§ Ø­Ø¯ Ø§Ù…Ú©Ø§Ù† Ø§Ø² Ù¾ÛŒ Ø¯ÛŒ Ø§Ù Ù‡Ø§ÛŒ Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯">ØªØ§ Ø­Ø¯ Ø§Ù…Ú©Ø§Ù† Ø§Ø² Ù¾ÛŒ Ø¯ÛŒ Ø§Ù Ù‡Ø§ÛŒ Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯</pre>


    </div>

    <script>
        alert("Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù…ÛŒØªÙˆÙ†ÛŒØ¯ Ù…ØªÙ† Ù¾ÛŒ Ø¯ÛŒ Ø§Ù Ø±Ùˆ Ø®ÙˆØ¯ØªÙˆÙ† Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ Ø§Ø² Ø§ÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…ØªÙ† Ø¨Ø§ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©ÛŒÙÛŒØª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯")
        pdfInput.onchange = e => {
            if (e.target.files[0]) startProcess(e.target.files[0]);
        };

        function copyText() {
            const text = document.getElementById('output').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯');
            }).catch(err => {
                alert('Ú©Ù¾ÛŒ Ù†Ø´Ø¯: ' + err);
            });
        }

        function downloadText() {
            const text = output.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ocr.txt';
            a.click();
        }
    </script>
</body>

</html>